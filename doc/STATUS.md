# 开发状态报告

> 最后更新：2026-01-21  
> 版本：0.2.0-alpha

---

## 📊 总体进度

```
核心系统：    ████████████░░░░░░░░  60%
游戏逻辑：    ████████░░░░░░░░░░░░  40%
UI/UX：      ████████████████░░░░  80%
多人支持：    ░░░░░░░░░░░░░░░░░░░░   0%
```

---

## ✅ 已完成功能

### 1. 卡牌系统 (100%)

- [x] 唯一卡牌追踪
- [x] 使用状态管理（usedToday / usedThisLoop）
- [x] 每轮限用机制
- [x] 禁止牌定义与UI显示
- [x] 牌的放置（暗置）
- [x] 牌的撤回
- [x] 目标占用检查
- [x] 剧作家牌组（10张）
- [x] 主人公牌组（8张）

**实现文件**：
- `src/types/game.ts`: PlayerDeck, ActionCard, 牌组管理函数
- `src/store/gameStore.ts`: playCard, retreatCard, isTargetOccupied

### 2. UI 组件 (95%)

- [x] GameBoard - 游戏版图
- [x] LocationZone - 区域组件
- [x] CharacterCard - 角色卡片
  - [x] 点击切换能力显示
  - [x] 放牌模式下不切换（isPlacingCard）
  - [x] 角色立绘显示（Sprite Sheet 裁剪）
  - [x] 死亡效果（灰度+红X+禁用）
- [x] ActionCard - 行动牌显示
- [x] ActionHand - 手牌区
- [x] PlacedCards - 已放置牌显示
  - [x] 自己的牌：正面 + 撤回按钮
  - [x] 对方的牌：牌背
- [x] DeckReference - 牌组参考面板（右侧）
- [x] RulesReference - 规则速查面板（左侧）
  - [x] 身份能力
  - [x] 事件效果（当前剧本直接显示）
  - [x] 角色能力
  - [x] 手牌列表
  - [x] 其他事件（整体折叠，灰色）
- [x] GameInfo - 游戏信息面板
- [x] IndicatorDisplay - 指示物显示
- [x] RoleSelector - 角色选择

**待优化**：
- [ ] 移动端响应式适配

### 3. 角色系统 (100%)

- [x] 角色资产配置（characterAssets.ts）
  - [x] 32个角色立绘映射（8x4网格）
  - [x] Sprite Sheet 裁剪函数
  - [x] 缩放支持
- [x] 角色定义完善
  - [x] FS-01 所有角色能力
  - [x] 友好度需求（单个或多个）
  - [x] 不安上限
  - [x] 禁行区域
- [x] 死亡机制
  - [x] 视觉效果（灰度+红X）
  - [x] 禁用交互（pointer-events: none）
  - [x] 无法被选为目标
  - [x] 移动牌自动跳过

**实现文件**：
- `src/lib/characterAssets.ts`: 角色资产映射
- `doc/character-assets.md`: 资产文档
- `doc/character-definitions.md`: 角色定义文档

### 4. 游戏逻辑 (40%)

#### 已实现

- [x] 游戏初始化（initializeGameState）
- [x] 角色状态初始化（initializeCharacterState）
- [x] 移动牌处理（applyMovement）
- [x] 指示物变更（applyIndicatorChange）
- [x] 事件触发检查（canIncidentTrigger）
- [x] 轮回重置（resetLoop）
- [x] 天数推进（advanceDay）
- [x] 胜负判定（isGameOver - 基础版）
- [x] 死亡角色目标检查（page.tsx）

#### 结算系统

- [x] 移动牌优先结算
- [x] 禁止牌抵消逻辑
  - [x] 同目标同类型抵消
  - [x] 移动禁止
  - [x] 友好禁止
  - [x] 不安禁止
  - [x] 密谋禁止
- [x] 指示物牌应用
- [x] 地点密谋处理（只有密谋牌生效）

#### 缺失功能

- [ ] 黎明阶段（亲友+1友好）
- [ ] 夜晚阶段
  - [ ] 杀人狂能力
  - [ ] 杀手能力
- [ ] 角色能力执行
  - [ ] 友好能力UI
  - [ ] 能力效果应用
- [ ] 完整事件处理
  - [x] 谋杀（murder）
  - [x] 自杀（suicide）
  - [ ] 医院事故（hospital_incident）
  - [ ] 远距离谋杀（faraway_murder）
- [ ] 最终决战
  - [ ] 身份推理UI
  - [ ] 推理判定

---

## 🚧 进行中

### 当前冲刺目标

- [ ] 实现完整一日流程
  - [ ] 黎明阶段
  - [ ] 行动阶段（已完成）
  - [ ] 结算阶段（已完成）
  - [ ] 能力阶段
  - [ ] 事件阶段（部分完成）
  - [ ] 夜晚阶段

---

## 📋 下一步计划

### Sprint 1: 完善游戏循环 (预计 3-5 天)

1. **黎明阶段实现**
   - 识别"亲友"身份
   - 自动+1友好
   - UI提示

2. **夜晚阶段实现**
   - 杀人狂能力（同区域杀人）
   - 杀手能力（密谋≥2杀关键人物）
   - UI提示

3. **角色能力系统**
   - 能力触发UI（按钮）
   - 能力效果应用
   - 使用次数追踪

### Sprint 2: 多主人公支持 (预计 2-3 天)

1. **状态管理扩展**
   - GameStore 支持多个 protagonistDeck
   - 当前活跃主人公选择
   - 轮流打牌逻辑

2. **UI 适配**
   - 主人公切换按钮
   - 多人手牌显示
   - 行动顺序指示

### Sprint 3: 最终决战 (预计 3-4 天)

1. **推理UI**
   - 身份选择界面
   - 推理历史记录
   - 提示系统

2. **判定逻辑**
   - 身份验证
   - 胜负判定
   - 结果展示

### Sprint 4: 多剧本支持 (预计 2-3 天)

1. **剧本加载器**
   - 动态加载剧本数据
   - 剧本选择UI
   - 难度标识

2. **新剧本**
   - FS-02
   - MS-01（中级）

---

## 🐛 已知 Bug

| ID | 描述 | 优先级 | 状态 |
|----|------|--------|------|
| - | 无严重 Bug | - | - |

---

## 🔧 技术债务

### 高优先级

1. **多剧本支持**
   - 当前硬编码 FS-01
   - 需要剧本加载器

2. **多主人公实现**
   - 当前只有单主人公测试模式
   - 需扩展 GameStore

### 中优先级

1. **引擎与剧本解耦**
   - engine.ts 硬编码 FS01_CHARACTERS
   - 应移入 PublicInfo

2. **移动端适配**
   - 当前只适配桌面端
   - 需要响应式布局优化

### 低优先级

1. **性能优化**
   - 大量 filter/map 操作
   - 可考虑 useMemo

2. **代码分割**
   - RulesReference 数据量大
   - 可拆分为独立模块

---

## 📈 性能指标

| 指标 | 当前值 | 目标值 |
|------|--------|--------|
| 首屏加载时间 | ~800ms | <1000ms |
| 页面大小 | ~500KB | <800KB |
| TypeScript 编译 | 无错误 | 保持 |
| ESLint 检查 | 无错误 | 保持 |

---

## 🎯 里程碑

- [x] **M1**: 基础框架搭建 (2026-01-15)
- [x] **M2**: 卡牌系统完成 (2026-01-21)
- [ ] **M3**: 完整游戏循环 (预计 2026-01-26)
- [ ] **M4**: 多主人公支持 (预计 2026-01-30)
- [ ] **M5**: 可玩版本发布 (预计 2026-02-10)

---

## 📝 更新日志

### 2026-01-21

**新增**：
- ✨ 角色能力切换显示（点击查看）
- ✨ 规则速查面板优化（事件分类显示）
- ✨ 选牌时不翻转角色卡片

**优化**：
- 🎨 PlacedCards 组件视觉效果
- 🎨 DeckReference 面板布局
- 📝 文档更新（architecture.md, README.md, STATUS.md）

**修复**：
- 🐛 禁止牌结算逻辑

---

**下次更新预计**: 2026-01-22 - 黎明/夜晚阶段实现
